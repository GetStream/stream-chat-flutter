name: stream_flutter_workflow

env:
  ACTIONS_ALLOW_UNSECURE_COMMANDS: 'true'

on:
  pull_request:
  push:
    branches:
      - master
    paths-ignore:
      - 'docs/**'

jobs:
  analyze:
    if: github.base_ref == 'master'
    timeout-minutes: 15
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - name: 'Install Flutter'
        run: ./.github/workflows/scripts/install-flutter.sh stable
      - name: 'Install Tools'
        run: |
          ./.github/workflows/scripts/install-tools.sh
          flutter pub global activate tuneup
      - name: 'Bootstrap Workspace'
        run: melos bootstrap
      - name: 'Dart Analyze'
        run: |
          melos exec -c 3 --ignore="*example*" -- \
            tuneup check
      - name: 'Pub Check'
        run: |
          melos exec -c 1 --no-private --ignore="*example*" -- \
            pub publish --dry-run
  format:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - name: 'Install Flutter'
        run: ./.github/workflows/scripts/install-flutter.sh stable
      - name: 'Install Tools'
        run: |
          ./.github/workflows/scripts/install-tools.sh
      - name: 'Bootstrap Workspace'
        run: melos bootstrap
      - name: 'Dart'
        run: |
          melos exec -c 1 -- \
            flutter format .
          ./.github/workflows/scripts/validate-formatting.sh

  test_dart:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - name: 'Install Flutter'
        run: ./.github/workflows/scripts/install-flutter.sh stable
      - name: 'Install Tools'
        run: |
          ./.github/workflows/scripts/install-tools.sh
          flutter pub global activate coverage
      - name: 'Bootstrap Workspace'
        run: melos bootstrap
      - name: 'Flutter Test'
        run: |
          cd packages/stream_chat
          flutter pub run test --coverage coverage/
          format_coverage --lcov --in=coverage/ --out=lcov.info --packages=.packages --report-on=lib
      - name: CodeCov
        run: bash <(curl -s https://codecov.io/bash) -t ${{ secrets.CODECOV_TOKEN }} -f packages/stream_chat/lcov.info -F stream_chat
      - uses: VeryGoodOpenSource/very_good_coverage@v1.1.1
        with:
          path: packages/stream_chat/lcov.info
          min_coverage: 50

  test_flutter:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - name: 'Install Flutter'
        run: ./.github/workflows/scripts/install-flutter.sh stable
      - name: 'Install Tools'
        run: ./.github/workflows/scripts/install-tools.sh
      - name: 'Bootstrap Workspace'
        run: melos bootstrap
      - name: 'Flutter Test'
        run: |
          melos exec -c 3 --flutter --dir-exists=test --ignore="*example*" --ignore="*web*" -- \
            flutter test --coverage
      - name: CodeCov
        run: bash <(curl -s https://codecov.io/bash) -t ${{ secrets.CODECOV_TOKEN }} -f packages/stream_chat_persistence/coverage/lcov.info -F stream_chat_persistence
